import pandas as pd
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from gspread_dataframe import get_as_dataframe
import os

scope = ["https://spreadsheets.google.com/feeds", "https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name("JSON", scope)
client = gspread.authorize(creds)

sheet = client.open('Recent Spotify Plays').sheet1
df_new = get_as_dataframe(sheet, evaluate_formulas=True).dropna(how="all")
df_new = df_new.drop(df_new.columns[4], axis=1)

csv_path = "2014_06July2025cleaned.csv"

if os.path.exists(csv_path):
    df_existing = pd.read_csv(csv_path)
    # Optional: ensure column names match
    df_new.columns = df_existing.columns
    
    df_combined = pd.concat([df_existing, df_new])
    
    df_combined = df_combined.drop_duplicates(subset=['Date/Time'])
else:
    df_combined = df_new

df_combined.to_csv('2014_06July2025cleaned.csv', index=False)
